<!--
Tracks tasks for the Chip & Board Support workstream.
-->
# Chip & Board Support Workstream TODO

## Purpose
Unify chip and board configuration data into self-contained crates per vendor so that `rlvgl-creator` and its UI can dynamically populate drop-downs of vendors, microcontrollers and boards. Today the creator references a single `.ioc` or CSV file directly; this work stream extracts all supported devices into dedicated vendor crates and wires them into the build and publish pipeline.

## Pre-setup Instructions
1. **Establish vendor crate locations**
   - Create a new top-level directory (e.g. `chipdb/`) or reuse an existing `support/` subfolder to house vendor crates. Each vendor gets its own crate, such as `rlvgl-chips-stm` for STMicroelectronics devices, `rlvgl-chips-nrf` for Nordic, `rlvgl-chips-esp` for Espressif, `rlvgl-chips-nxp` for NXP, `rlvgl-chips-silabs` for Silicon Labs, `rlvgl-chips-microchip` for Microchip, `rlvgl-chips-renesas` for Renesas, `rlvgl-chips-ti` for Texas Instruments, and `rlvgl-chips-rp2040` for generic RP2040 support. All crates live under the workspace and inherit the same edition and license headers.
   - Include a `README.md` in each vendor crate describing the embedded board database format and how the crate integrates with `rlvgl-creator` so that it can be used independently.
2. **Add workspace members**
   - Update the root `Cargo.toml` `[workspace]` section to include the new vendor crates. This ensures they are compiled and published along with the rest of the repository.
   - For each vendor crate add a bare-bones `Cargo.toml` with:
     ```toml
     [package]
     name = "rlvgl-chips-stm"
     version = "0.0.1"
     edition = "2021"
     publish = true

     [lib]
     crate-type = ["rlib"]

     [dependencies]
     serde = { version = "1", features = ["derive"], optional = true }
     ```
     You can derive a similar template for other vendors. The optional `serde` feature allows the crate to optionally serialise/deserialise its board database.
3. **Bootstrapping `build.rs` for asset embedding**
   - Each vendor crate should contain a `build.rs` script that locates the extracted board definition files (generated by `tools/st_extract_af.py`, see below) and embeds them into the binary using `include_bytes!` or a custom archive builder. Use an environment variable (e.g. `RLVGL_CHIP_SRC`) to point to the directory of extracted definitions at build time. The build script can then iterate over that directory, compress or pack the files into a single archive (e.g. tar or zip), and emit a Rust source file that exposes a static `VENDOR_DB: &'static [u8]` or a typed wrapper around it.
   - Write a small wrapper API in `lib.rs` that exposes helper functions:
     - `fn vendor() -> &'static str` – returns the vendor name used by the UI.
     - `fn boards() -> &'static [BoardInfo]` – returns a list of available boards and microcontrollers.
     - `fn find(board_name: &str) -> Option<&'static BoardInfo>` – lookup by exact board or chip name.
   - A `BoardInfo` struct should include at minimum: board name, chip name, package, pin configuration blob offset/length and maybe a description.
4. **Extend the Python extraction tool**
   - The existing `tools/st_extract_af.py` extracts `.ioc` files under `chips/stm/...` into a normalised format. Extend this script to handle both `.ioc` and `.csv` sources. Detect the file type by extension; parse `.csv` pin descriptions into the same intermediate representation used for `.ioc` files (a JSON or YAML dictionary keyed by pin name and function). The output should be a single JSON or YAML file per board containing all pins, metadata, and the board/chip names. Place the generated files into a build cache directory (e.g. `build/chipdb/stm`).
   - Provide a command-line interface: `python tools/st_extract_af.py --input path/to/board_dir --output build/chipdb/stm`. Document usage in the script header and in this TODO; update `README.md` if needed.
   - Add unit tests for the parser that feed sample `.ioc` and `.csv` files and assert on the resulting dictionary keys/values. Place these tests under `tests/tools_st_extract_af.rs` so they run in CI.
5. **Update the publish workflow**
   - Modify the GitHub Actions or GitLab CI configuration to run the Python extraction script before packaging the vendor crates. For example, add a job that checks out the `chips/stm` submodule, executes `python tools/st_extract_af.py` with appropriate input/output directories, and then sets `RLVGL_CHIP_SRC` for the subsequent `cargo publish` step.
   - Ensure that the vendor crates are versioned and published whenever the extraction output changes. Use `cargo publish --dry-run` to validate before release.

## Tasks
### Level 1 – Vendor crate scaffolding
- [x] **Create rlvgl-chips-stm crate** – Set up the first vendor crate: directory, `Cargo.toml`, `build.rs`, `lib.rs` skeleton, and `README.md` describing usage and format. Depends on: Pre-setup
- [x] **Create rlvgl-chips-… crates** – For each additional vendor identified (Nordic, Espressif, NXP, Silicon Labs, Microchip, Renesas, Texas Instruments, generic RP2040), copy the STM template, including the `README.md`, and adjust package names. Depends on: STM crate
- [ ] **Implement BoardInfo API** – Define the `BoardInfo` struct and helper functions (`vendor`, `boards`, `find`) in each vendor crate. Depends on: STM crate
- [ ] **Embed extracted definitions** – Write build logic to read the JSON/YAML files produced by `st_extract_af.py` and pack them into the binary. Depends on: Python tool
- [ ] **Unit tests for vendor crates** – Add tests verifying that `boards()` returns the expected number of entries and that `find()` resolves known names. Depends on: API impl

### Level 2 – Python extraction & conversion
- [ ] **CSV parser integration** – Extend `tools/st_extract_af.py` to parse CSV pin descriptions into the same intermediate representation. Depends on: Pre-setup
- [ ] **Unified output format** – Ensure both `.ioc` and `.csv` sources produce a consistent JSON/YAML schema used by the vendor crates. Depends on: CSV parser
- [ ] **Command-line interface** – Add CLI flags for input directory, output directory and vendor name. Depends on: Unified format
- [ ] **Sample file tests** – Add automated tests in Rust or Python that process sample `.ioc` and `.csv` files and compare against expected snapshots. Depends on: CSV parser
- [ ] **Documentation** – Document the usage of the script and the expected file formats in the repository’s `README.md` and in this TODO. Depends on: CLI

### Level 3 – Creator integration
- [ ] **Add vendor crate dependencies** – Update `rlvgl-creator`'s `Cargo.toml` to depend on each vendor crate via path or workspace. Depends on: Vendor crates
- [ ] **Public API to enumerate boards** – Add functions in creator to iterate over all vendor crates and build a flat list of Vendor → Boards entries. Depends on: Vendor API
- [ ] **UI drop-down support** – On the creator branch’s UI (see `rlvgl/creator-ui`), update the board selection component to present vendor, chip and board options loaded from the crates. Depends on: Enumeration API
- [ ] **Exact name matching** – Ensure that the UI selection uses exact matching to find board definitions in the vendor crates. Depends on: UI support
- [ ] **Fallback / error handling** – Define behaviour when a vendor crate or board is missing; display a clear message rather than panicking. Depends on: UI support

### Level 4 – Publish & CI integration
- [ ] **CI extraction step** – Add a CI job that runs `tools/st_extract_af.py` against the `chips/stm` submodule and any other vendor submodules. Depends on: Python CLI
- [ ] **Environment variable wiring** – Pass `RLVGL_CHIP_SRC` or similar environment variables into the vendor crate build to locate the generated files. Depends on: CI extraction
- [ ] **Cargo publish matrix** – Extend the release workflow to publish each vendor crate along with core, ui, and other crates. Depends on: Vendor crates
- [ ] **Version bump automation** – Write a script or adopt `cargo release` to bump versions across vendor crates when new definitions are generated. Depends on: Publish matrix
- [ ] **Update docs and changelog** – Add release notes summarising supported chips/boards and instructions for using the new crates with creator. Depends on: Publish matrix

## Definition of Done
- All vendor crates compile and expose a stable API returning board definitions.
- The Python extraction script can parse both `.ioc` and `.csv` and produces consistent outputs; tests cover representative samples.
- `rlvgl-creator` can list vendors, chips and boards via the new crates, and the UI drop-downs populate correctly.
- CI runs extraction and publishes updated vendor crates; version numbers bump automatically when definitions change.
- Documentation in `README.md` and this TODO is up to date, and `docs/TEST-TODO.md` includes new test IDs covering chip support (e.g. T-19 for vendor enumeration, T-20 for board loading smoke test).
